# 테넌트 간 동기화

Contoso는 최근 Tailwind Traders를 인수했으며 어떤 게스트가 고객 또는 파트너이며 인수한 회사의 직원인지 확인하기가 어려웠습니다. Tailwind Traders에서 Contoso로 초기 일반 주소 목록을 제공하는 작업을 수행합니다. 또한 테넌트는 알려진 도메인 이름만 Entra ID에 게스트 사용자로 추가하도록 허용해야 합니다. 조직에 게스트를 초대할 수 있는 사용자를 내부 사용자로만 제한하려고 합니다. 외부 액세스를 하나의 도메인으로만 제한합니다. Tailwind Traders에서 Contoso로의 B2B Collaboration 및 테넌트 간 동기화도 만듭니다.

사이버 보안 설계자는 모든 요구 사항이 충족되는지 확인하고 Entra ID에 필요한 변경 내용을 구현하여 제로 트러스트 원칙을 적용해야 합니다. 이 연습에서는 랩 파트너와 협력하여 테넌트 간 동기화를 만듭니다.

## 1부: 솔루션 설계(필수)

이 작업에서는 Contoso Ltd. 및 Tailwind Traders가 직면하고 있는 요구 사항을 해결하기 위한 개념을 설계합니다.

### 디자인 접근 방법

초기 단계에서는 설명된 시나리오에 따라 요구 사항을 분석하고, 목표를 이해하고, 요구 사항을 정의합니다.

제공된 사용 사례에 따라 다음 요구 사항을 설명할 수 있습니다.

- 두 회사의 사용자 동기화
- 외부 사용자를 외부로 식별할 수 있도록 설정
- 내부 직원에게만 초대 권한 제한 
- 회사가 신뢰할 수 있는 도메인에 대한 외부 액세스 제한

두 번째 단계에서는 Contoso Ltd.의 기존 환경을 검사합니다. Microsoft Entra ID는 외부 협업을 가능하게 하는 솔루션을 제공합니다. 어떤 컨트롤과 정책이 이미 존재하는지를 조사합니다. Entra ID 포털을 사용하여 현재 구성 및 정책을 검토하고 수행할 요구 사항을 충족하기 위해 구현해야 하는 조정을 결정합니다.

세 번째 단계는 솔루션의 개념을 만드는 것입니다. 조사 결과 테넌트 간 동기화가 공동 작업이 모든 요구 사항을 충족할 수 있도록 하는 가장 좋은 방법임이 확인됐습니다.  

### 제안된 솔루션

|요건|솔루션|작업 플랜:|
|----|----|----|
|내부 직원에게만 초대 권한 제한|외부 협업 설정|테넌트 구성원 및 특정 관리자 초대 역할에만 초대 권한 제한|
|신뢰할 수 있는 도메인 목록을 제외한 모든 도메인에서 초대 차단|외부 협업 설정|신뢰할 수 있는 도메인만 포함하는 초대 허용 목록 만들기|
|두 회사의 사용자 동기화|Entra ID 테넌트 간 동기화|두 Entra ID 테넌트 간에 액세스 트러스트를 설정하고 사용자를 다른 테넌트와 동기화하는 구성을 만듭니다.|
|외부 사용자를 외부로 식별할 수 있도록 설정|테넌트 간 특성 매핑|테넌트 간 동기화 구성의 특성 매핑 함수를 사용하여 사용자 지정 식을 만들어 동기화된 모든 사용자의 displayName 특성을 편집합니다.|

## 파트 2: 솔루션 구현(선택 사항)

### 작업 1 - 팀 구성 및 준비

이 작업에서는 테넌트 간 동기화의 필수 구성 요소를 확인하고 랩 파트너와 협력합니다.

1. 클라이언트 1 VM(LON-Sc1)에 **lon-sc1\admin** 계정으로 로그인합니다. 암호는 랩 호스팅 공급자가 제공합니다.
1. **Microsoft Edge**를 열고 주소 표시줄을 선택한 다음 **`https://entra.microsoft.com`** 로 이동하여 Entra ID 포털에 **MOD 관리자**(admin@WWLxZZZZZZ.onmicrosoft.com)로 로그인합니다(ZZZZZZ는 랩 호스팅 공급자가 제공한 고유 테넌트 ID). 관리자의 암호는 랩 호스팅 공급자가 제공합니다.
1. 다단계 인증을 설정하라는 메시지가 표시되면 지침을 따릅니다.
1. **로그인 상태를 유지하시겠습니까?** 대화 상자에서 **이 메시지를 다시 표시 안 함** 체크박스를 선택하고 **아니요**를 선택합니다.
1. 브라우저에 기본 전역 관리자 자격 증명을 저장하지 않으려면 **지금 안 함**을 선택하여 암호 저장 대화 상자를 닫습니다.
1. 왼쪽 탐색 창에서 **ID** > **개요**로 이동합니다.
1. **개요** 탭 아래에 표시되는 **테넌트 ID** 및 **기본 도메인**을 적어둡니다.
1. **테넌트 ID** 및 **기본 도메인**을 랩 파트너와 교환합니다.

사용하려는 토폴로지, 첫 번째 동기화 테스트의 범위에 포함되는 사용자 및 Contoso의 Entra ID 테넌트에 매핑할 방법을 계획해야 합니다.

### 작업 2 - 테넌트 간 액세스 구성

이제 테넌트 간 동기화 구현에 필요한 정보를 준비했으므로 이제 테넌트가 파트너의 테넌트에 액세스하는 데(반대의 경우도 마찬가지) 필요한 단계를 수행합니다.

1. 계속 Entra ID 포털 **https://entra.microsoft.com**에 로그인된 상태이어야 합니다.
1. 왼쪽 탐색 모음에서 **ID** > **External Identities** > **테넌트 간 액세스 설정**으로 이동합니다.
1. **조직 설정** 탭을 선택하고 **조직 추가**를 선택합니다.
1. 랩 파트너가 제공한 테넌트 ID로 **테넌트 ID 또는 도메인 이름** 필드를 입력하고 **추가**를 선택합니다.
1. Contoso에 대한 **인바운드 액세스**에서 **기본값에서 상속됨**을 선택하여 해당 특정 테넌트에 대한 테넌트 간 동기화 설정에 액세스합니다.
1. **신뢰 설정**에서 **테넌트 Contoso에서 자동 초대 사용**을 사용하도록 설정합니다.
1. **저장**을 선택합니다.
1. **테넌트 간 동기화**에서 **사용자가 이 테넌트와 동기화하도록 허용**을 사용하도록 설정합니다.
1. 오른쪽 위 모서리에 있는 **X**를 사용하여 **저장**을 선택하고 대화 상자를 닫습니다.
1. Contoso에 대한 **아웃바운드 액세스**에서 **기본값에서 상속됨**을 선택하여 해당 특정 테넌트에 대한 테넌트 간 동기화 설정에 액세스합니다.
1. **신뢰 설정**에서 **테넌트 Contoso에서 자동 초대**를 사용하도록 설정합니다.
1. 오른쪽 위 모서리에 있는 **X**를 사용하여 **저장**을 선택하고 대화 상자를 닫습니다.

사용자가 초대를 수동으로 사용할 필요 없이 테넌트가 파트너의 테넌트와 두 가지 방법을 모두 동기화할 수 있도록 설정했습니다. 

### 작업 3 - 외부 액세스 제한

이 작업에서는 초대를 보낼 수 있는 권한이 있는 사용자의 범위를 제어하여 조직에 새 게스트 사용자를 초대하는 기능을 제한합니다. 파트너의 테넌트 도메인에 게스트로 초대할 수 있는 도메인의 범위를 제한합니다.

1. 계속 Entra ID 포털 **https://entra.microsoft.com**에 로그인된 상태이어야 합니다.
1. 왼쪽 탐색 창에서 **ID** > **External Identities** > **외부 공동 작업 설정**으로 이동합니다.
1. **게스트 초대 설정** 섹션에서 **특정 관리자 역할에 할당된 멤버 사용자는 멤버 권한이 있는 게스트를 비롯한 게스트 사용자를 초대할 수 있음**을 선택합니다.
1. **협업 제한**에서 **지정된 도메인에만 초대 허용**을 선택합니다.
1. 랩 파트너의 도메인 **WWLxZZZZZZ.onmicrosoft.com**을 추가합니다(여기서 ZZZZZZ는 랩 호스팅 공급자가 제공하는 랩 파트너의 고유한 테넌트 ID임).
1. **저장**을 선택합니다.

이제 초대할 수 있는 사용자와 테넌트에 초대될 수 있는 사용자를 제한했습니다.

### 작업 4 - 구성 만들기

이 작업에서는 기본 구성을 만들고 다른 테넌트에 대한 연결을 테스트합니다.

1. 계속 Entra ID 포털 **https://entra.microsoft.com**에 로그인된 상태이어야 합니다.
1. 왼쪽 탐색 창에서 **ID** > **External Identities** > **테넌트 간 동기화** > **구성**으로 이동합니다.
1. **새 구성** 만들기
1. **Contoso 테넌트 간 동기화** 이름을 입력하고 **만들기**를 선택합니다.
1. **프로비전**에서 **프로비전 모드**를 **자동**으로 변경합니다.
1. **테넌트 ID** 상자에 작업 1에서 적어둔 파트너의 테넌트 ID를 입력합니다.
1. **연결 테스트**를 클릭합니다.
1. **저장**을 선택합니다.

액세스 설정을 올바르게 구성했다면 제공된 자격 증명에 프로비전을 사용하도록 설정할 권한이 있다는 메시지가 표시됩니다. 연결 테스트가 실패하면 파트너가 작업 3에서 올바른 도메인을 입력했는지 확인하고 작업 2에 설명된 대로 테넌트 간 동기화를 구성했는지 확인합니다.

### 작업 5 - 사용자 범위 정의

이 작업에서는 첫 번째 동기화 범위에 있는 사용자를 정의합니다.

1. 방금 만든 구성의 프로비전 설정에서 Entra ID 포털 **https://entra.microsoft.com**에 로그인되어야 합니다. 그렇지 않으면 다음 3단계를 수행하여 해당 단계로 .
   1. 왼쪽 탐색 창에서 **ID** > **External Identities** > **테넌트 간 동기화** > **구성**으로 이동합니다.
   1. **Contoso 테넌트 간 동기화**를 선택합니다.
   1. **프로비전**으로 이동합니다.
1. **설정** 섹션을 확장합니다.
1. 범위 드롭다운이 **할당된 사용자 및 그룹만 동기화**되도록 설정되어 있는지 확인합니다.
1. 설정을 변경한 경우 **저장**을 선택합니다.
1. 탐색 창에서 **사용자 및 그룹**을 선택합니다.
1. **사용자/그룹 추가**를 선택합니다.
1. **할당 추가** 페이지에서 **선택하지 않음**을 선택합니다.
1. **법무**를 검색하고 확인란을 사용해 **법무 팀**을 강조 표시한 다음 **선택**을 선택합니다.
1. **할당**을 선택하여 두 사용자로 구성된 팀을 동기화 범위에 추가합니다.

이제 파트너의 테넌트에 동기화할 첫 번째 사용자 범위를 정의했습니다.

### 작업 6 - 특성 매핑 검토

이 작업에서는 특성 매핑을 검토하고 동기화된 사용자가 Contoso의 전체 주소 목록에 표시되도록 합니다.

1. 테넌트 간 동기화 구성의 **사용자 및 그룹** 설정에서 계속 Entra ID 포털**https://entra.microsoft.com**에 로그인되어 있어야 합니다. 아닌 경우 다음 2단계를 수행하여 구성 페이지로 돌아갑니다.
   1. 왼쪽 탐색 창에서 **ID** > **외부 ID** > **테넌트 간 동기화** > **구성**으로 이동합니다.
   1. **Contoso 테넌트 간 동기화**를 선택합니다.
1. **프로비전**으로 이동해 **매핑** 섹션을 펼칩니다.
1. **Microsoft Entra ID 사용자 프로비전**을 선택합니다.
1. **showInAddressList** 특성 아래에서 편집을 선택합니다.
1. 매핑 형식이 **상수**로 설정되고 해당 값이 **true**로 설정되어 있는지 확인합니다.
1. **확인**을 선택합니다.
1. **displayName** 특성 아래에서 **편집**을 선택합니다.
1. 매핑 형식을 **식**으로 변경합니다.
1. 기존 식을 제거합니다.
1. **식 작성기 사용**을 선택합니다.
1. **Append** 함수를 선택합니다.
1. **특성 선택** 필드의 드롭다운 목록에서 **[displayName]** 특성을 선택합니다.
1. **접미사 입력** 필드에 **' (Contoso)'** 를 입력하되, 괄호 앞 공백은 포함하고 따옴표는 제거합니다.
1. **식 추가**를 선택합니다. 오른쪽의 식은 다음과 같아야 합니다. `Append([displayName], " (Contoso)")` 
1. 사용자를 선택하여 식을 테스트할 수 있습니다.
1. **식 적용**을 선택하고 **확인**을 선택하여 편집 대화 상자를 떠납니다.
1. **저장**을 선택합니다.
1. 오른쪽 위 모서리의 **X**를 선택하여 특성 매핑 페이지를 닫습니다.

이제 동기화된 모든 사용자가 다른 테넌트의 전체 주소 목록에 표시되도록 했습니다. 또한 다른 테넌트 내에서 동기화된 모든 사용자의 표시 이름에 (Contoso) 식을 추가했습니다.

### 작업 7 - 프로비전 사용 설정 및 랩 파트너와 함께 테스트

이 작업에서는 프로비전을 사용하도록 설정하고 사용자가 다른 테넌트에서 필요한 방식으로 표시되는지 테스트합니다. 자동 프로비저닝에는 다소 시간이 걸릴 수 있으므로 수동 프로비저닝을 트리거하겠습니다.

1. 계속 Entra ID 포털 **https://entra.microsoft.com**에 로그인되어 있고 테넌트 간 동기화 구성의 프로비전 설정에 있어야 합니다. 아닌 경우 다음 2단계를 수행하여 구성 페이지로 돌아갑니다.
   1. 왼쪽 탐색 창에서 **ID** > **외부 ID** > **테넌트 간 동기화** > **구성**으로 이동합니다.
   1. **Contoso 테넌트 간 동기화**를 선택합니다.
1. **주문형 프로비전**으로 이동합니다.
1. 범위가 지정된 **Legal team**의 구성원 **`Grady Archie`** 를 검색합니다.
1. **프로비전**을 선택합니다.
    - 프로비전이 완료되면 확인 메시지가 표시됩니다.
1. 화면 오른쪽 위의 **X**를 선택하여 수행 동작 페이지를 닫습니다.

첫 번째 사용자를 수동으로 프로비전했습니다. 이제 파트너 테넌트의 사용자 목록을 확인하면 사용자 Grady Archie(Contoso)가 표시됩니다.

### 작업 8 - 전체 동기화 롤아웃

첫 번째 사용자 프로비저닝을 성공적으로 테스트했으므로 이제 남아 있는 사용자 목록을 다른 테넌트에 프로비전하겠습니다.

1. 계속 Entra ID 포털 **https://entra.microsoft.com**에 로그인되어 있고 테넌트 간 동기화 구성의 **주문형 프로비전** 페이지에 있어야 합니다. 아닌 경우 다음 2단계를 수행하여 구성 페이지로 돌아갑니다.
   1. 왼쪽 탐색 창에서 **ID** > **외부 ID** > **테넌트 간 동기화** > **구성**으로 이동합니다.
   1. **Contoso 테넌트 간 동기화**를 선택합니다.
1. **사용자 및 그룹**을 선택합니다.
1. **사용자/그룹 추가**를 선택합니다.
1. **할당 추가** 페이지에서 **선택하지 않음**을 선택합니다.
1. **모든 Contoso 직원**이 포함된 그룹이므로 **모든 직원** 그룹을 선택합니다.
1. 선택을 확인합니다.
1. **할당**을 선택합니다.

이제 테넌트와 다른 테넌트 간에 테넌트 간 동기화를 성공적으로 만들었습니다. 데모 테넌트에서 수행한 모든 작업을 Tailwind Traders의 생산적인 시스템에 맞게 조정하고 Contoso에 통합할 수 있어야 합니다.
